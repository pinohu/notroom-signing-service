// Prisma Schema for Notroom National Signing Service
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  ADMIN
  TITLE_COMPANY
  NOTARY
  BORROWER
}

enum NotaryTier {
  BRONZE
  SILVER
  GOLD
  ELITE
}

enum NotaryStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum OrderStatus {
  DRAFT
  PENDING_ASSIGNMENT
  ASSIGNED
  ACCEPTED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
  FAILED
}

enum OrderType {
  PURCHASE
  REFINANCE
  HELOC
  REVERSE_MORTGAGE
  SELLER_FINANCE
  COMMERCIAL
  EQUITY_LINE
  CONSTRUCTION
  VA
  FHA
  USDA
  CONVENTIONAL
}

enum SigningType {
  IN_PERSON
  RON
  HYBRID
}

enum ServiceTier {
  STANDARD
  PRIORITY
  RESCUE
}

enum AssignmentStatus {
  OFFERED
  ACCEPTED
  DECLINED
  EXPIRED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  ACH
  CHECK
  WIRE
  PAYPAL
  VENMO
  ZELLE
}

enum DocumentType {
  LOAN_PACKAGE
  DEED
  MORTGAGE
  NOTE
  DISCLOSURE
  POWER_OF_ATTORNEY
  TRUST
  AFFIDAVIT
  OTHER
}

enum DocumentQAStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_REVIEW
}

enum IntegrationType {
  API
  EMAIL
  PORTAL
  SNAPDOCS
  SIGNING_ORDER
}

enum OnboardingStatus {
  IN_PROGRESS
  PENDING_REVIEW
  PENDING_BACKGROUND_CHECK
  PENDING_VERIFICATION
  APPROVED
  REJECTED
}

enum BackgroundCheckProvider {
  NNA_UPLOAD
  EXISTING_SIGNING_SERVICE
  INTELLICORP
  GOODHIRE_BASIC
  GOODHIRE_ENHANCED
  CHECKR_BASIC
  VERIFIED_CREDENTIALS
}

enum BackgroundCheckStatus {
  NOT_STARTED
  PENDING_PAYMENT
  PAYMENT_FAILED
  PENDING
  IN_PROGRESS
  CLEAR
  CONSIDER
  FAILED
  ERROR
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  passwordHash  String?
  role          UserRole  @default(BORROWER)
  phone         String?
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  notary        Notary?
  titleCompany  TitleCompanyUser?
  notifications Notification[]
  onboarding    NotaryOnboarding?

  @@index([email])
  @@index([role])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// NOTARY
// ============================================================================

model Notary {
  id                   String       @id @default(cuid())
  userId               String       @unique
  
  // Personal Info
  firstName            String
  lastName             String
  email                String
  phone                String
  alternatePhone       String?
  address              Json?        // Full address object
  streetAddress        String?
  city                 String?
  state                String?
  zipCode              String?
  latitude             Float?
  longitude            Float?
  serviceRadius        Int          @default(25) // miles
  
  // Commission Details
  commissionState      String
  commissionNumber     String
  commissionExpiry     DateTime
  additionalStates     String[]     @default([])
  
  // RON Authorization
  ronAuthorized        Boolean      @default(false)
  ronProvider          String?      // e.g., "Proof", "NotaryCam"
  ronCertificationDate DateTime?
  
  // Insurance & Background
  eoAmount             Int          @default(0)
  eoCarrier            String?
  eoExpiry             DateTime?
  eAndOAmount          Decimal?     @db.Decimal(10, 2)
  eAndOExpiry          DateTime?
  eAndOCarrier         String?
  backgroundCheckDate  DateTime?
  backgroundCheckClear Boolean      @default(false)
  
  // Equipment
  equipmentVerified    Boolean      @default(false)
  hasDualTrayPrinter   Boolean      @default(false)
  hasScanner           Boolean      @default(false)
  hasReliableVehicle   Boolean      @default(false)
  
  // Certifications
  nnaCertified         Boolean      @default(false)
  nnaNumber            String?
  lssCertified         Boolean      @default(false)
  
  // Status & Tier
  status               NotaryStatus @default(PENDING)
  tier                 NotaryTier   @default(BRONZE)
  eliteScore           Int          @default(0) // 0-100
  
  // Preferences
  acceptsWeekends      Boolean      @default(true)
  acceptsEvenings      Boolean      @default(true)
  acceptsHospital      Boolean      @default(false)
  acceptsJail          Boolean      @default(false)
  languages            String[]     @default(["English"])
  
  // Specializations
  specializations      String[]     @default([])
  loanTypes            String[]     @default([])
  
  // Service Areas
  serviceAreas         String[]     @default([])
  maxTravelDistance    Int          @default(25)
  
  // Banking for Payments
  bankAccountLast4     String?
  bankRoutingLast4     String?
  preferredPayment     PaymentMethod @default(ACH)
  
  // Timestamps
  approvedAt           DateTime?
  lastActiveAt         DateTime?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  // Relations
  user                 User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignments          Assignment[]
  performance          NotaryPerformance?
  stateCommissions     NotaryStateCommission[]
  availability         NotaryAvailability[]

  @@index([commissionState])
  @@index([status])
  @@index([tier])
  @@index([eliteScore])
  @@index([zipCode])
  @@index([ronAuthorized])
  @@map("notaries")
}

model NotaryOnboarding {
  id               String            @id @default(cuid())
  userId           String            @unique
  
  // Progress tracking
  currentStep      Int               @default(1)
  completedSteps   Int[]             @default([])
  status           OnboardingStatus  @default(IN_PROGRESS)
  
  // Data storage (JSON for flexibility)
  data             Json              @default("{}")
  
  // Timestamps
  startedAt        DateTime          @default(now())
  lastUpdatedAt    DateTime          @default(now())
  submittedAt      DateTime?
  approvedAt       DateTime?
  rejectedAt       DateTime?
  rejectionReason  String?
  
  // Relations
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([status])
  @@index([submittedAt])
  @@map("notary_onboardings")
}

model BackgroundCheckPayment {
  id                  String                  @id @default(cuid())
  onboardingId        String
  userId              String
  
  // Provider details
  provider            BackgroundCheckProvider
  providerCheckId     String?
  
  // Payment details
  stripeSessionId     String                  @unique
  stripePaymentIntent String?
  amount              Int                     // Amount in cents
  currency            String                  @default("usd")
  
  // Status tracking
  status              BackgroundCheckStatus   @default(PENDING_PAYMENT)
  invitationUrl       String?
  reportUrl           String?
  adjudication        String?                 // CLEAR, CONSIDER, etc.
  
  // Timestamps
  createdAt           DateTime                @default(now())
  paidAt              DateTime?
  initiatedAt         DateTime?
  completedAt         DateTime?
  updatedAt           DateTime                @updatedAt
  
  // Webhook tracking
  lastWebhookAt       DateTime?
  webhookData         Json?
  
  @@index([onboardingId])
  @@index([userId])
  @@index([stripeSessionId])
  @@index([status])
  @@map("background_check_payments")
}

model NotaryStateCommission {
  id               String   @id @default(cuid())
  notaryId         String
  stateCode        String
  commissionNumber String
  commissionExpiry DateTime
  ronAuthorized    Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  notary Notary @relation(fields: [notaryId], references: [id], onDelete: Cascade)

  @@unique([notaryId, stateCode])
  @@index([stateCode])
  @@map("notary_state_commissions")
}

model NotaryAvailability {
  id        String   @id @default(cuid())
  notaryId  String
  dayOfWeek Int      // 0=Sunday, 6=Saturday
  startTime String   // "09:00"
  endTime   String   // "17:00"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  notary Notary @relation(fields: [notaryId], references: [id], onDelete: Cascade)

  @@unique([notaryId, dayOfWeek])
  @@map("notary_availability")
}

model NotaryPerformance {
  id                String     @id @default(cuid())
  notaryId          String     @unique
  
  // Rates (stored as percentages 0-100)
  acceptanceRate    Float      @default(0)
  onTimeRate        Float      @default(0)
  errorRate         Float      @default(0)
  firstPassRate     Float      @default(0)
  clientSatisfaction Float     @default(0)
  
  // Counts
  totalSignings     Int        @default(0)
  completedSignings Int        @default(0)
  cancelledSignings Int        @default(0)
  noShowCount       Int        @default(0)
  errorCount        Int        @default(0)
  
  // Averages
  avgConfirmTime    Int?       // minutes
  avgResponseTime   Int?       // minutes
  avgScanbackTime   Int?       // minutes
  
  // Tier
  tier              NotaryTier @default(BRONZE)
  tierUpdatedAt     DateTime?
  
  // Timestamps
  lastCalculatedAt  DateTime   @default(now())
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  notary Notary @relation(fields: [notaryId], references: [id], onDelete: Cascade)

  @@map("notary_performance")
}

// ============================================================================
// TITLE COMPANY
// ============================================================================

model TitleCompany {
  id                String          @id @default(cuid())
  
  // Company Info
  name              String
  dba               String?
  phone             String
  fax               String?
  email             String
  website           String?
  
  // Address
  address           String
  city              String
  state             String
  zipCode           String
  
  // Primary Contact
  primaryContactName  String
  primaryContactEmail String
  primaryContactPhone String
  
  // Billing
  billingAddress    String?
  billingCity       String?
  billingState      String?
  billingZipCode    String?
  paymentTerms      Int             @default(30) // Net days
  creditLimit       Decimal?        @db.Decimal(10, 2)
  
  // Integration
  integrationType   IntegrationType @default(PORTAL)
  apiKey            String?         @unique
  webhookUrl        String?
  
  // Preferences
  defaultServiceTier ServiceTier    @default(STANDARD)
  requiresScanback  Boolean         @default(true)
  scanbackDeadline  Int             @default(24) // hours
  
  // Status
  isPilot           Boolean         @default(true)
  pilotEndDate      DateTime?
  isActive          Boolean         @default(true)
  
  // Timestamps
  onboardedAt       DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  users             TitleCompanyUser[]
  orders            Order[]
  invoices          Invoice[]
  preferences       TitleCompanyPreference[]

  @@index([name])
  @@index([state])
  @@index([isActive])
  @@map("title_companies")
}

model TitleCompanyUser {
  id             String   @id @default(cuid())
  userId         String   @unique
  titleCompanyId String
  role           String   @default("user") // admin, user, viewer
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  titleCompany TitleCompany @relation(fields: [titleCompanyId], references: [id], onDelete: Cascade)

  @@index([titleCompanyId])
  @@map("title_company_users")
}

model TitleCompanyPreference {
  id             String   @id @default(cuid())
  titleCompanyId String
  stateCode      String
  preferredTier  ServiceTier @default(STANDARD)
  customFee      Decimal?    @db.Decimal(10, 2)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  titleCompany TitleCompany @relation(fields: [titleCompanyId], references: [id], onDelete: Cascade)

  @@unique([titleCompanyId, stateCode])
  @@map("title_company_preferences")
}

// ============================================================================
// ORDER
// ============================================================================

model Order {
  id                  String       @id @default(cuid())
  orderNumber         String       @unique @default(cuid())
  
  // Title Company
  titleCompanyId      String
  clientReferenceId   String?      // Client's internal reference
  
  // Status
  status              OrderStatus  @default(DRAFT)
  signingType         SigningType  @default(IN_PERSON)
  serviceTier         ServiceTier  @default(STANDARD)
  orderType           OrderType    @default(PURCHASE)
  
  // Loan Details
  loanAmount          Decimal?     @db.Decimal(12, 2)
  loanNumber          String?
  lenderName          String?
  
  // Property
  propertyAddress     String
  propertyCity        String
  propertyState       String
  propertyZipCode     String
  propertyType        String?      // SFR, Condo, Multi-family
  
  // Signing Location (can differ from property)
  signingAddress      String?
  signingCity         String?
  signingState        String?
  signingZipCode      String?
  signingLocationType String?      // Home, Office, Hospital, etc.
  
  // Borrower Info
  borrowerName        String
  borrowerEmail       String?
  borrowerPhone       String?
  coBorrowerName      String?
  coBorrowerEmail     String?
  coBorrowerPhone     String?
  
  // Scheduling
  scheduledDatetime   DateTime?
  scheduledEndTime    DateTime?
  timeZone            String       @default("America/New_York")
  isFlexibleTime      Boolean      @default(false)
  
  // Documents
  documentCount       Int          @default(0)
  pageCount           Int          @default(0)
  
  // Completion
  completionDatetime  DateTime?
  scanbackReceivedAt  DateTime?
  shippedAt           DateTime?
  trackingNumber      String?
  carrier             String?
  
  // QA
  qaStatus            DocumentQAStatus @default(PENDING)
  qaReviewedAt        DateTime?
  qaReviewedBy        String?
  qaNotes             String?
  
  // Pricing
  baseFee             Decimal      @db.Decimal(10, 2)
  rushFee             Decimal?     @db.Decimal(10, 2)
  travelFee           Decimal?     @db.Decimal(10, 2)
  additionalFees      Decimal?     @db.Decimal(10, 2)
  totalFee            Decimal      @db.Decimal(10, 2)
  
  // SLA
  confirmationDeadline DateTime?
  scanbackDeadline     DateTime?
  slaBreached          Boolean     @default(false)
  
  // Notes
  specialInstructions String?
  internalNotes       String?
  cancellationReason  String?
  
  // Timestamps
  submittedAt         DateTime?
  assignedAt          DateTime?
  acceptedAt          DateTime?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  // Relations
  titleCompany        TitleCompany @relation(fields: [titleCompanyId], references: [id])
  assignments         Assignment[]
  documents           Document[]
  statusHistory       OrderStatusHistory[]
  invoiceItems        InvoiceItem[]

  @@index([orderNumber])
  @@index([titleCompanyId])
  @@index([status])
  @@index([propertyState])
  @@index([scheduledDatetime])
  @@index([createdAt])
  @@map("orders")
}

model OrderStatusHistory {
  id        String      @id @default(cuid())
  orderId   String
  status    OrderStatus
  notes     String?
  changedBy String?
  createdAt DateTime    @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("order_status_history")
}

// ============================================================================
// ASSIGNMENT
// ============================================================================

model Assignment {
  id               String           @id @default(cuid())
  orderId          String
  notaryId         String
  
  // Status
  status           AssignmentStatus @default(OFFERED)
  
  // Timestamps
  offeredAt        DateTime         @default(now())
  offerExpiresAt   DateTime?
  acceptedAt       DateTime?
  declinedAt       DateTime?
  completedAt      DateTime?
  cancelledAt      DateTime?
  
  // Decline/Cancel Reason
  declineReason    String?
  cancelReason     String?
  
  // Payment
  paymentAmount    Decimal          @db.Decimal(10, 2)
  travelAllowance  Decimal?         @db.Decimal(10, 2)
  bonusAmount      Decimal?         @db.Decimal(10, 2)
  totalPayment     Decimal          @db.Decimal(10, 2)
  paymentStatus    PaymentStatus    @default(PENDING)
  
  // Performance Tracking
  confirmationTime Int?             // minutes from offer to accept
  arrivalTime      DateTime?
  departureTime    DateTime?
  
  // Notes
  notaryNotes      String?
  adminNotes       String?
  
  // Timestamps
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  order            Order            @relation(fields: [orderId], references: [id])
  notary           Notary           @relation(fields: [notaryId], references: [id])
  payment          Payment?

  @@index([orderId])
  @@index([notaryId])
  @@index([status])
  @@index([offeredAt])
  @@map("assignments")
}

// ============================================================================
// DOCUMENT
// ============================================================================

model Document {
  id           String           @id @default(cuid())
  orderId      String
  
  // Document Info
  name         String
  type         DocumentType     @default(OTHER)
  description  String?
  
  // File URLs
  originalUrl  String?          // Original uploaded document
  signedUrl    String?          // Signed document
  scanbackUrl  String?          // Scanned back document
  
  // Metadata
  pageCount    Int?
  fileSize     Int?             // bytes
  mimeType     String?
  
  // QA
  qaStatus     DocumentQAStatus @default(PENDING)
  qaReviewedAt DateTime?
  qaReviewedBy String?
  qaNotes      String?
  
  // Tracking
  printedAt    DateTime?
  signedAt     DateTime?
  scannedAt    DateTime?
  
  // Timestamps
  uploadedAt   DateTime         @default(now())
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([type])
  @@index([qaStatus])
  @@map("documents")
}

// ============================================================================
// STATE REQUIREMENTS
// ============================================================================

model StateRequirement {
  id              String   @id @default(cuid())
  stateCode       String   @unique
  stateName       String
  
  // RON Rules
  allowsRon       Boolean  @default(false)
  ronEffectiveDate DateTime?
  ronProviders    String[] @default([])
  
  // Witness Requirements
  witnessRequired Boolean  @default(false)
  witnessCount    Int      @default(0)
  
  // Journal Requirements
  journalRequired Boolean  @default(true)
  eJournalAllowed Boolean  @default(true)
  
  // ID Requirements
  acceptedIds     String[] @default(["drivers_license", "passport", "state_id"])
  idExpiredAllowed Boolean @default(false)
  
  // Document-Specific Rules
  deedRonAllowed  Boolean  @default(true)
  powerOfAttorneyRonAllowed Boolean @default(false)
  
  // Fees & Limits
  maxNotaryFee    Decimal? @db.Decimal(10, 2)
  travelFeeAllowed Boolean @default(true)
  
  // Special Rules (JSON for flexibility)
  specificRules   Json?
  
  // Notes
  notes           String?
  lastVerified    DateTime?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([stateCode])
  @@index([allowsRon])
  @@map("state_requirements")
}

// ============================================================================
// PAYMENT
// ============================================================================

model Payment {
  id            String        @id @default(cuid())
  assignmentId  String        @unique
  
  // Amount
  amount        Decimal       @db.Decimal(10, 2)
  
  // Status
  status        PaymentStatus @default(PENDING)
  
  // Processing
  method        PaymentMethod @default(ACH)
  processedAt   DateTime?
  transactionId String?
  
  // External References
  externalId    String?       // Payment processor ID
  batchId       String?       // For batch payments
  
  // Failure Info
  failureReason String?
  retryCount    Int           @default(0)
  lastRetryAt   DateTime?
  
  // Timestamps
  scheduledFor  DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  assignment Assignment @relation(fields: [assignmentId], references: [id])

  @@index([status])
  @@index([processedAt])
  @@index([batchId])
  @@map("payments")
}

// ============================================================================
// INVOICE (For Title Companies)
// ============================================================================

model Invoice {
  id             String        @id @default(cuid())
  invoiceNumber  String        @unique
  titleCompanyId String
  
  // Amounts
  subtotal       Decimal       @db.Decimal(10, 2)
  tax            Decimal       @default(0) @db.Decimal(10, 2)
  total          Decimal       @db.Decimal(10, 2)
  
  // Status
  status         PaymentStatus @default(PENDING)
  
  // Dates
  issuedAt       DateTime      @default(now())
  dueAt          DateTime
  paidAt         DateTime?
  
  // Payment
  paymentMethod  String?
  paymentRef     String?
  
  // Timestamps
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  titleCompany TitleCompany  @relation(fields: [titleCompanyId], references: [id])
  items        InvoiceItem[]

  @@index([titleCompanyId])
  @@index([status])
  @@index([dueAt])
  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  orderId     String?
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  order   Order?  @relation(fields: [orderId], references: [id])

  @@index([invoiceId])
  @@map("invoice_items")
}

// ============================================================================
// NOTIFICATION
// ============================================================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // order_assigned, payment_received, etc.
  title     String
  message   String
  data      Json?
  read      Boolean  @default(false)
  readAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String   // CREATE, UPDATE, DELETE
  entityType String   // Order, Assignment, etc.
  entityId   String
  oldData    Json?
  newData    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
